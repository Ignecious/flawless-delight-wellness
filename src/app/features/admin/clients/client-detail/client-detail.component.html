<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '80vw' }"
  [breakpoints]="{ '960px': '95vw' }"
  (onHide)="closeDialog()"
>
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <h2>Client Details</h2>
    </div>
  </ng-template>

  <div class="client-detail-content">
    <!-- Section 1: Contact Information -->
    <section class="contact-section">
      <div class="contact-header">
        <h2 class="client-name">{{ client.name }}</h2>
        <p-badge 
          [value]="client.status" 
          [severity]="getClientStatusSeverity(client.status)"
          styleClass="status-badge"
        ></p-badge>
      </div>
      
      <div class="contact-info">
        <div class="info-item">
          <i class="pi pi-envelope"></i>
          <span>{{ client.email }}</span>
        </div>
        <div class="info-item">
          <i class="pi pi-phone"></i>
          <span>{{ client.phone }}</span>
        </div>
        <div class="info-item">
          <i class="pi pi-calendar"></i>
          <span>Customer since {{ formatDate(client.customerSince) }}</span>
        </div>
      </div>
    </section>

    <!-- Section 2: Statistics Cards -->
    <section class="statistics-section">
      <div class="stats-grid">
        <p-card styleClass="stat-card">
          <ng-template pTemplate="content">
            <div class="stat-content">
              <i class="pi pi-dollar stat-icon"></i>
              <div class="stat-info">
                <div class="stat-label">Total Spent</div>
                <div class="stat-value">{{ formatCurrency(client.totalSpent) }}</div>
              </div>
            </div>
          </ng-template>
        </p-card>

        <p-card styleClass="stat-card">
          <ng-template pTemplate="content">
            <div class="stat-content">
              <i class="pi pi-calendar-plus stat-icon"></i>
              <div class="stat-info">
                <div class="stat-label">Total Bookings</div>
                <div class="stat-value">{{ client.totalBookings }}</div>
              </div>
            </div>
          </ng-template>
        </p-card>

        <p-card styleClass="stat-card">
          <ng-template pTemplate="content">
            <div class="stat-content">
              <i class="pi pi-user stat-icon"></i>
              <div class="stat-info">
                <div class="stat-label">Preferred Therapist</div>
                <div class="stat-value">{{ client.preferredTherapist || 'N/A' }}</div>
              </div>
            </div>
          </ng-template>
        </p-card>
      </div>
    </section>

    <!-- Section 3: Active Packages -->
    <section class="active-packages-section" *ngIf="activePackages.length > 0">
      <h3>Active Packages</h3>
      
      <div class="packages-list">
        <div class="active-package-card" *ngFor="let pkg of activePackages">
          <div class="package-header">
            <h4>ðŸ“¦ {{ pkg.packageName }}</h4>
            <p-badge 
              [value]="pkg.status" 
              severity="success"
            ></p-badge>
          </div>
          
          <div class="package-info">
            <p><strong>Purchased:</strong> {{ formatPackageDate(pkg.purchaseDate) }}</p>
            <p [class]="getExpiryWarningClass(calculateDaysRemaining(pkg.expiryDate))">
              <strong>Expires:</strong> {{ formatPackageDate(pkg.expiryDate) }} 
              ({{ calculateDaysRemaining(pkg.expiryDate) }} days remaining)
            </p>
          </div>
          
          <div class="progress-section">
            <div class="progress-label">
              Progress: {{ getTotalCompletedTreatments(pkg) }}/{{ getTotalTreatments(pkg) }} completed
            </div>
            <p-progressBar 
              [value]="calculateProgressPercentage(pkg)"
              [showValue]="false"
              styleClass="package-progress">
            </p-progressBar>
          </div>
          
          <div class="completed-treatments" *ngIf="hasCompletedTreatments(pkg)">
            <h5>Completed Treatments:</h5>
            <ul>
              <ng-container *ngFor="let treatment of pkg.treatments">
                <li *ngFor="let session of treatment.completedSessions">
                  <span class="checkmark">âœ…</span>
                  <span>{{ treatment.treatmentName }} - {{ formatPackageDate(session.date) }} ({{ session.therapistName }})</span>
                </li>
              </ng-container>
            </ul>
          </div>
          
          <div class="remaining-treatments" *ngIf="hasRemainingTreatments(pkg)">
            <h5>Remaining Treatments:</h5>
            <ul>
              <li *ngFor="let treatment of pkg.treatments">
                <ng-container *ngIf="treatment.remainingQuantity > 0">
                  <span class="calendar-icon">ðŸ“…</span>
                  <span>{{ treatment.remainingQuantity }}x {{ treatment.treatmentName }}</span>
                </ng-container>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <section class="no-packages-section" *ngIf="activePackages.length === 0">
      <h3>Active Packages</h3>
      <p class="no-data">No active packages</p>
    </section>

    <!-- Section 4: Booking History -->
    <section class="booking-history-section">
      <h3>Booking History</h3>
      <div class="table-wrapper">
        <p-table 
          [value]="clientBookings" 
          [scrollable]="true"
          scrollHeight="300px"
          styleClass="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Date</th>
              <th>Treatment</th>
              <th>Therapist</th>
              <th>Price</th>
              <th>Status</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-booking>
            <tr>
              <td>{{ formatDate(booking.date) }}</td>
              <td>{{ booking.treatment.name }}</td>
              <td>{{ booking.therapist.name }}</td>
              <td>{{ formatCurrency(booking.treatment.price) }}</td>
              <td>
                <p-badge 
                  [value]="booking.status" 
                  [severity]="getStatusSeverity(booking.status)"
                ></p-badge>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center">No bookings found</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </section>

    <!-- Section 5: Favorite Treatments -->
    <section class="favorite-treatments-section">
      <h3>Favorite Treatments</h3>
      <div class="treatments-list" *ngIf="client.favoriteTreatments.length > 0; else noTreatments">
        <div class="treatment-item" *ngFor="let treatment of client.favoriteTreatments">
          <i class="pi pi-star-fill"></i>
          <span>{{ treatment.treatmentName }} ({{ treatment.count }} booking{{ treatment.count > 1 ? 's' : '' }})</span>
        </div>
      </div>
      <ng-template #noTreatments>
        <p class="no-data">No favorite treatments yet</p>
      </ng-template>
    </section>

    <!-- Section 6: Notes -->
    <section class="notes-section">
      <h3>Notes</h3>
      <textarea 
        pInputTextarea 
        [(ngModel)]="editableNotes"
        [rows]="4"
        placeholder="Add notes about this client..."
        class="notes-textarea"
      ></textarea>
      <div class="notes-actions">
        <p-button 
          label="Save Notes" 
          icon="pi pi-save"
          (onClick)="saveNotes()"
        ></p-button>
      </div>
    </section>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button 
        label="Edit Contact Info" 
        icon="pi pi-pencil"
        [outlined]="true"
        (onClick)="editContactInfo()"
      ></p-button>
      <p-button 
        label="Book Appointment" 
        icon="pi pi-calendar-plus"
        [outlined]="true"
        (onClick)="bookAppointment()"
      ></p-button>
      <p-button 
        label="Close" 
        icon="pi pi-times"
        (onClick)="closeDialog()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
